#!/bin/sh

PORT="${PORT:-6502}"
RACK_ENV=development

export PORT
export RACK_ENV

set -e 
if [ -f tmp/pidfile ]; then
  echo "[ $0 ] pidfile found"
  pid=$(cat tmp/pidfile)
  if ps -p "${pid}" > /dev/null; then
    echo "[ $0 ] Attempting to kill PID '${pid}'"
    kill "${pid}"
  else
    echo "[ $0 ] PID '${pid}' no longer running"
  fi
  if timeout 5 tail --pid="${pid}" -f /dev/null; then
    echo "[ $0 ] PID '${pid}' stopped. Restarting server"
  else
    echo "[ $0 ] PID '${pid}' has not stopped. Trying kill -9"
    kill -9 "${pid}"
    if timeout 1 tail --pid="${pid}" -f /dev/null; then
      echo "[ $0 ] PID '${pid}' killed. Restarting server"
    else
      echo "[ $0 ] PID '${pid}' still running. Something seriously wrong"
    fi
    exit 1
  fi

else
  echo "[ $0 ] No pidfile-Starting up"
fi
bundle exec rackup --port "${PORT}" --host 0.0.0.0 --env "${RACK_ENV}" --pid tmp/pidfile
